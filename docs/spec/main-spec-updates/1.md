# Spec Update 1

Post Development Review - November 2021

---

## API

### Documentation
- The API is described in an openapi spec in `openapi.yaml`.
- This can be accessed on the HTTP server under `/docs/openapi`.
- This spec is used to produce interactive API documentation, under `/docs`.
- **This spec and resultant Swagger docs must be updated when the API is updated, and are the source of truth (well, other than the actual code) of what the API does.**

## New Features

### Renaming Columns

- When submitting a samples file, it is possible to either rename columns or add new columns with each value having a fixed value. The process behind this is described in comments in `api.py`, under the POST handler for `/studies`.
- The corresponding frontend page has the ability to use this feature. The user can add and delete tuplets of ```|old value|new value|column value|``` to make use of this.

### Generating Minimal VCF Files
- Sometimes the user wants to generate a minimal VCF file to upload instead of uploading the entire dataset.
- When passed to the backend (requires the signal type to actually be a variant), it'll download the original VCF from S3, send it to the `uploadtogenestack` package to make a new minimal VCF file, and then just use that as the data file
- The frontend supports this by having a tick box for "Generate Minimal VCF File" if the selected signal type is a variant

### Version Numbering
- This is now very important given that both this app and the `uploadtogenestack` package are being updated, and can have updating versions.
- The `/` endpoint on the API now returns both the version of this software (defined in `config.py`, and also used in the naming of the Docker image), and the version of the package (defined in the package's `setup.py`, the appropriate tag on GitLab and therefore the cloning URL in the Dockerfile)
- These are all displayed, along with the Genestack server in use defined by the environment variable `GSSERVER` at the bottom of the main page (authentication and study selection).

### S3 Policies
- Whenever we need to use a S3 bucket, we need to ensure we have the correct policies set.
- This is managed by a context manager in `s3.py`.
- This needs SSH keys at `~/.ssh/id_rsa_genestack` and `~/.ssh/id_rsa_genestack.pub` to connect to the Genestack VM.
- It is **still a requirement** that a public policy is set to start the app, otherwise it will instantly throw a `PermissionError`.

### Help Text
- Most of the frontend pages have basic help text available to the user. This is provided through a modal component in `frontend/utils/HelpModal.jsx`.
- The text in the help text modal is defined in `frontend/utils/helpText.js`.

## Other

### App Base URL
- Although any endpoints generated by the app will automatically take into account any base paths used, such as `/genestack-uploader/` in nginx, any links generated from anything bolted onto the app won't account for this. 
- This needs defining in two places **before** the Docker image is built - the image will have this information baked in. This is why we tag the image with either `.dev` or `.prod`, to show which base URL is being used.
- It's important to remember that this `.dev` or `.prod` tag doesn't affect which Genestack instance we connect to - this is given by the environment variable `GSSERVER`, which can be provided at runtime.
- The base URL must be defined in **both** `frontend/.env` and `config.py`.
- `frontend/.env` must define the full base URL in the variable `NEXT_PUBLIC_HOST`.
- `config.py` must define the path only in `BASE_URL`.
- For example, if we host on `https://apps.hgi.sanger.ac.uk/genestack-uploader`, where this URL will lead us to the auth page, we'll define that URL in `NEXT_PUBLIC_HOST` and `/genestack-uploader` in `BASE_URL`.

### Running the App
- When running in development, running the `app.py` file will run Flask in development mode
- In production, we use waitress, and the `production` function in `app.py`. The command is `waitress-serve --call app:production`, although this is handled by the Dockerfile.

### Signal Subtypes
- In the file `frontend/pages/studies/[studyid]/index.jsx`, there is the concept of a `Signal Subtype`. This is the type of signal, typically either `expression` or `variant`. The naming scheme comes from trying to filter a Genestack template into "subtypes" based on what is being created, i.e. study or signal.